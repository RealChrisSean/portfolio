<script>
// Audio Player
(function() {
    let audioPlayer = null;
    let isPlaying = false;
    let isLoading = false;
    let paragraphs = [];
    let paragraphTimings = [];
    let wordTimings = [];

    // Auto-detect blog slug from URL
    function getBlogSlug() {
        const path = window.location.pathname;
        const match = path.match(/\/blog\/([^\/]+)/);
        return match ? match[1] : null;
    }

    const blogSlug = getBlogSlug();
    const PRECACHED_AUDIO = blogSlug ? `/audio/${blogSlug}.mp3` : null;
    const PRECACHED_TIMESTAMPS = blogSlug ? `/audio/${blogSlug}-timestamps.json` : null;

    function getReadableParagraphs() {
        const article = document.querySelector('article.container');
        const elements = article.querySelectorAll('h2, h3, p, li');
        const readable = [];

        elements.forEach(el => {
            if (el.closest('.post-header, .toc, .author-section, .footer, .demo-box, .architecture-diagram, pre, code, table, nav, .scroll-indicator, .audio-progress, .mobile-toc')) {
                return;
            }
            const text = el.textContent.trim();
            if (text.length > 10) {
                readable.push({ element: el, text });
            }
        });

        return readable;
    }

    function getArticleText() {
        paragraphs = getReadableParagraphs();
        return paragraphs.map(p => p.text).join(' ');
    }

    function calculateParagraphTimings(duration) {
        const totalChars = paragraphs.reduce((sum, p) => sum + p.text.length, 0);
        let currentTime = 0;

        paragraphTimings = paragraphs.map(p => {
            const start = currentTime;
            const paragraphDuration = (p.text.length / totalChars) * duration;
            currentTime += paragraphDuration;
            return { start, end: currentTime, element: p.element };
        });
    }

    function highlightCurrentParagraph(currentTime) {
        document.querySelectorAll('.tts-highlight').forEach(el => {
            el.classList.remove('tts-highlight');
        });

        if (wordTimings.length > 0) {
            let currentWordIndex = -1;
            for (let i = 0; i < wordTimings.length; i++) {
                if (currentTime >= wordTimings[i].start && currentTime < wordTimings[i].end) {
                    currentWordIndex = i;
                    break;
                }
                if (currentTime < wordTimings[i].start) {
                    currentWordIndex = Math.max(0, i - 1);
                    break;
                }
            }

            if (currentWordIndex >= 0) {
                const startIdx = Math.max(0, currentWordIndex - 2);
                const endIdx = Math.min(wordTimings.length, currentWordIndex + 3);
                const phrase = wordTimings.slice(startIdx, endIdx).map(w => w.word).join(' ').toLowerCase();

                for (const p of paragraphs) {
                    if (p.text.toLowerCase().includes(phrase) ||
                        phrase.includes(p.text.toLowerCase().substring(0, 30))) {
                        p.element.classList.add('tts-highlight');
                        return;
                    }
                }

                const currentWord = wordTimings[currentWordIndex].word.toLowerCase();
                for (const p of paragraphs) {
                    if (p.text.toLowerCase().includes(currentWord)) {
                        p.element.classList.add('tts-highlight');
                        return;
                    }
                }
            }
        } else {
            for (let i = 0; i < paragraphTimings.length; i++) {
                const timing = paragraphTimings[i];
                if (currentTime >= timing.start && currentTime < timing.end) {
                    timing.element.classList.add('tts-highlight');
                    break;
                }
            }
        }
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateUI(state) {
        const player = document.getElementById('audioPlayer');
        const btn = document.getElementById('listenBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const loadingIcon = document.getElementById('loadingIcon');

        if (!player || !btn) return;

        playIcon.style.display = 'none';
        pauseIcon.style.display = 'none';
        loadingIcon.style.display = 'none';

        switch (state) {
            case 'loading':
                player.classList.add('visible');
                document.body.classList.add('audio-playing');
                loadingIcon.style.display = 'block';
                btn.disabled = true;
                break;
            case 'playing':
                player.classList.add('visible');
                document.body.classList.add('audio-playing');
                pauseIcon.style.display = 'block';
                btn.disabled = false;
                break;
            case 'paused':
                player.classList.add('visible');
                document.body.classList.add('audio-playing');
                playIcon.style.display = 'block';
                btn.disabled = false;
                break;
            default:
                player.classList.remove('visible');
                document.body.classList.remove('audio-playing');
                playIcon.style.display = 'block';
                btn.disabled = false;
                document.querySelectorAll('.tts-highlight').forEach(el => {
                    el.classList.remove('tts-highlight');
                });
        }
    }

    window.seekAudio = function(event) {
        if (!audioPlayer) return;
        const bar = event.currentTarget;
        const rect = bar.getBoundingClientRect();
        const percent = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
        audioPlayer.currentTime = percent * audioPlayer.duration;
    };

    window.closeAudioPlayer = function() {
        if (audioPlayer) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayer = null;
        }
        isPlaying = false;
        updateUI('idle');
    };

    window.toggleAudio = async function() {
        if (isLoading) return;

        if (audioPlayer && isPlaying) {
            audioPlayer.pause();
            isPlaying = false;
            updateUI('paused');
            return;
        }

        if (audioPlayer && !isPlaying) {
            audioPlayer.play();
            isPlaying = true;
            updateUI('playing');
            return;
        }

        if (!PRECACHED_AUDIO) {
            alert('Audio not available for this page.');
            return;
        }

        isLoading = true;
        updateUI('loading');

        try {
            getArticleText();

            let audioUrl = PRECACHED_AUDIO;
            let usedCache = false;

            try {
                const [audioCheck, timestampsResponse] = await Promise.all([
                    fetch(PRECACHED_AUDIO, { method: 'HEAD' }),
                    fetch(PRECACHED_TIMESTAMPS)
                ]);

                if (audioCheck.ok && timestampsResponse.ok) {
                    usedCache = true;
                    const timestampData = await timestampsResponse.json();
                    wordTimings = timestampData.words || [];
                }
            } catch (e) {
                console.log('Pre-cached files not available');
            }

            if (!usedCache) {
                const text = paragraphs.map(p => p.text).join(' ');
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        voice: 'kdvGwzzf2ihYtjbv5OWc',
                        stability: 0.5,
                        similarity: 0.75
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'TTS request failed');
                }

                const blob = await response.blob();
                audioUrl = URL.createObjectURL(blob);
            }

            audioPlayer = new Audio(audioUrl);

            audioPlayer.addEventListener('loadedmetadata', () => {
                calculateParagraphTimings(audioPlayer.duration);
            });

            audioPlayer.addEventListener('timeupdate', () => {
                const progressFill = document.getElementById('audioProgressFill');
                const timeDisplay = document.getElementById('audioTime');
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = percent + '%';
                timeDisplay.textContent = `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;

                highlightCurrentParagraph(audioPlayer.currentTime);
            });

            audioPlayer.addEventListener('ended', () => {
                isPlaying = false;
                audioPlayer = null;
                updateUI('idle');
            });

            audioPlayer.play();
            isPlaying = true;
            isLoading = false;
            updateUI('playing');

        } catch (error) {
            console.error('TTS error:', error);
            isLoading = false;
            updateUI('idle');
            alert('Failed to load audio. Please try again.');
        }
    };
})();
</script>
