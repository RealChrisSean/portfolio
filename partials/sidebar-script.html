<script>
// Sidebar TOC functionality
(function() {
    const sidebarLinks = document.querySelectorAll('.sidebar-toc-list a');
    const mobileLinks = document.querySelectorAll('.mobile-toc-dropdown a');
    const mobileToc = document.querySelector('.mobile-toc');
    const mobileToggle = document.querySelector('.mobile-toc-toggle');
    const sections = [];

    // Collect all section targets
    sidebarLinks.forEach(link => {
        const id = link.getAttribute('href').slice(1);
        const section = document.getElementById(id);
        if (section) {
            sections.push({ id, element: section, link });
        }
    });

    // Mobile dropdown toggle
    if (mobileToggle && mobileToc) {
        mobileToggle.addEventListener('click', () => {
            mobileToc.classList.toggle('open');
        });

        // Close dropdown when clicking a link
        mobileLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileToc.classList.remove('open');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileToc.contains(e.target)) {
                mobileToc.classList.remove('open');
            }
        });
    }

    // Highlight current section
    function updateActiveSection() {
        let current = null;

        for (const section of sections) {
            const rect = section.element.getBoundingClientRect();
            if (rect.top <= 150) {
                current = section;
            }
        }

        // Update desktop sidebar
        sidebarLinks.forEach(link => link.classList.remove('active'));
        if (current) {
            current.link.classList.add('active');
        }

        // Update mobile dropdown
        mobileLinks.forEach(link => {
            link.classList.remove('active');
            if (current && link.getAttribute('href') === '#' + current.id) {
                link.classList.add('active');
            }
        });
    }

    // Throttled scroll handler
    let ticking = false;
    window.addEventListener('scroll', () => {
        if (!ticking) {
            requestAnimationFrame(() => {
                updateActiveSection();
                ticking = false;
            });
            ticking = true;
        }
    });

    // Initial state
    updateActiveSection();
})();
</script>
