<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building a Voice-to-Text App That Learns Your Style (Without Storing Your Words) | Chris Dabatos</title>
    <meta name="description" content="Privacy-first style learning with TiDB vector search. Can you teach an AI how someone writes by storing statistics only?">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Building a Voice-to-Text App That Learns Your Style (Without Storing Your Words)">
    <meta property="og:description" content="Privacy-first style learning with TiDB vector search. Can you teach an AI how someone writes by storing statistics only?">
    <meta property="og:image" content="https://realchrissean.com/imgs/speak-it-hero.jpeg">
    <meta property="og:url" content="https://realchrissean.com/blog/speak-it/">
    <meta property="og:type" content="article">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@RealChrisSean">
    <meta name="twitter:title" content="Building a Voice-to-Text App That Learns Your Style (Without Storing Your Words)">
    <meta name="twitter:description" content="Privacy-first style learning with TiDB vector search. Can you teach an AI how someone writes by storing statistics only?">
    <meta name="twitter:image" content="https://realchrissean.com/imgs/speak-it-hero.jpeg">

    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://realchrissean.com/blog/speak-it/">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": "Building a Voice-to-Text App That Learns Your Style (Without Storing Your Words)",
        "description": "Privacy-first style learning with TiDB vector search. Can you teach an AI how someone writes by storing statistics only?",
        "image": "https://realchrissean.com/imgs/speak-it-hero.jpeg",
        "author": {
            "@type": "Person",
            "name": "Chris Dabatos",
            "url": "https://realchrissean.com"
        },
        "publisher": {
            "@type": "Person",
            "name": "Chris Dabatos"
        },
        "datePublished": "2026-01-27",
        "dateModified": "2026-01-27",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://realchrissean.com/blog/speak-it/"
        }
    }
    </script>

    <link rel="icon" type="image/webp" href="../../imgs/cd_logo.webp">
    <link rel="apple-touch-icon" href="../../imgs/cd_logo.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/fontawesome-subset.css">
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        html {
            scroll-behavior: smooth;
        }

        :root {
            --bg-color: #ffffff;
            --card-bg: rgba(249, 250, 251, 0.9);
            --text-main: #101010;
            --text-muted: #555;
            --accent-primary: #0ea5e9;
            --accent-secondary: #6366f1;
            --accent-vegas: #c026d3;
            --border-color: rgba(0, 0, 0, 0.08);
            --code-bg: #f4f4f5;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-code: 'Fira Code', monospace;
        }

        [data-theme="dark"] {
            --bg-color: #0f0f0f;
            --card-bg: rgba(30, 30, 30, 0.9);
            --text-main: #f0f0f0;
            --text-muted: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.08);
            --code-bg: #1a1a1a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-color);
            color: var(--text-main);
            line-height: 1.7;
            font-size: 17px;
            overflow-x: hidden;
        }

        /* Background Animation Effect */
        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(circle at 15% 50%, rgba(14, 165, 233, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(192, 38, 211, 0.08), transparent 25%);
            filter: blur(40px);
        }

        .container {
            max-width: 760px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }

        nav {
            position: sticky;
            top: 0;
            background: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(12px);
        }

        nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s;
        }

        nav a:hover {
            color: var(--accent-primary);
        }

        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            color: var(--accent-primary);
            background: var(--card-bg);
        }

        .theme-toggle .fa-sun { display: none; }
        .theme-toggle .fa-moon { display: block; }
        [data-theme="dark"] .theme-toggle .fa-sun { display: block; }
        [data-theme="dark"] .theme-toggle .fa-moon { display: none; }

        /* Hero Header */
        .post-header {
            margin-bottom: 48px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border-color);
        }

        .post-tag {
            display: inline-block;
            padding: 6px 14px;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(192, 38, 211, 0.15));
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 20px;
        }

        .post-meta time {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reading-time {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h1 {
            font-size: 2.75rem;
            font-weight: 700;
            margin-bottom: 20px;
            line-height: 1.15;
            background: linear-gradient(135deg, var(--text-main) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.3rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        h2 {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 56px 0 20px;
            color: var(--text-main);
            position: relative;
            display: inline-block;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-vegas));
            border-radius: 2px;
        }

        h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 36px 0 12px;
            color: var(--accent-primary);
        }

        p {
            margin-bottom: 20px;
            color: var(--text-main);
        }

        ul, ol {
            margin: 16px 0 24px;
            padding-left: 24px;
        }

        li {
            margin-bottom: 10px;
        }

        strong {
            font-weight: 600;
            color: var(--accent-primary);
        }

        code {
            font-family: var(--font-code);
            background: var(--code-bg);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.88em;
            border: 1px solid var(--border-color);
        }

        /* VS Code Dark Theme Style */
        pre[class*="language-"] {
            background: #1e1e1e !important;
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            margin: 28px 0;
            border: 1px solid #333;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* VS Code title bar */
        pre[class*="language-"]::before {
            content: '';
            display: block;
            background: #323233;
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            position: relative;
        }

        /* Window control dots */
        pre[class*="language-"]::after {
            content: '';
            position: absolute;
            top: 14px;
            left: 16px;
            width: 12px;
            height: 12px;
            background: #ff5f56;
            border-radius: 50%;
            box-shadow: 20px 0 0 #ffbd2e, 40px 0 0 #27ca40;
        }

        pre[class*="language-"] code {
            display: block;
            padding: 20px 24px;
            overflow-x: auto;
            font-size: 0.85rem;
            line-height: 1.7;
            background: transparent !important;
            border: none;
        }

        /* Override Prism theme for VS Code colors */
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #6a9955 !important;
        }

        .token.punctuation {
            color: #d4d4d4 !important;
        }

        .token.property,
        .token.tag,
        .token.boolean,
        .token.number,
        .token.constant,
        .token.symbol {
            color: #b5cea8 !important;
        }

        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin {
            color: #ce9178 !important;
        }

        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string {
            color: #d4d4d4 !important;
        }

        .token.atrule,
        .token.attr-value,
        .token.keyword {
            color: #569cd6 !important;
        }

        .token.function,
        .token.class-name {
            color: #dcdcaa !important;
        }

        .token.regex,
        .token.important,
        .token.variable {
            color: #d16969 !important;
        }

        code[class*="language-"],
        pre[class*="language-"] {
            color: #d4d4d4 !important;
            text-shadow: none !important;
        }

        /* Inline code (not in pre) */
        :not(pre) > code {
            background: var(--code-bg);
            color: #e06c75;
        }

        [data-theme="dark"] :not(pre) > code {
            background: #2d2d2d;
            color: #e06c75;
        }

        /* Callout Box */
        .callout {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(192, 38, 211, 0.05));
            border-left: 4px solid var(--accent-primary);
            border-radius: 0 12px 12px 0;
            padding: 20px 24px;
            margin: 32px 0;
        }

        .callout p {
            margin: 0;
            font-style: italic;
        }

        /* Data table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--card-bg);
            font-weight: 600;
            color: var(--accent-primary);
        }

        tr:hover {
            background: var(--card-bg);
        }

        hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            margin: 56px 0;
        }

        /* Author Section */
        .author-section {
            margin-top: 64px;
            padding: 32px;
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .author-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-primary);
        }

        .author-info {
            flex: 1;
        }

        .author-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-main);
        }

        .author-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .author-links {
            display: flex;
            gap: 12px;
        }

        .author-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .author-links a:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        /* Footer */
        .footer {
            margin-top: 64px;
            padding-top: 32px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .footer-social {
            display: flex;
            gap: 1.5rem;
            font-size: 1.5rem;
            justify-content: center;
            margin-bottom: 24px;
        }

        .footer-social a {
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .footer-social a:hover {
            color: var(--accent-primary);
            transform: translateY(-3px);
        }

        /* Architecture diagram */
        .architecture-diagram {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            font-family: var(--font-code);
            font-size: 0.85rem;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre;
        }

        @media (max-width: 640px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.4rem; }
            .container { padding: 24px 16px 60px; }
            body { font-size: 16px; }
            .author-section {
                flex-direction: column;
                text-align: center;
            }
            .author-links {
                justify-content: center;
            }
        }

        /* Reading Progress Bar */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: linear-gradient(90deg, #0ea5e9, #38bdf8, #0ea5e9);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
            z-index: 9999;
            transition: width 0.1s ease-out;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Scroll Animations */
        .fade-up {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .fade-up.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Stagger animation delays for children */
        .fade-up:nth-child(1) { transition-delay: 0s; }
        .fade-up:nth-child(2) { transition-delay: 0.1s; }
        .fade-up:nth-child(3) { transition-delay: 0.2s; }
        .fade-up:nth-child(4) { transition-delay: 0.3s; }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 48px;
            height: 48px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        /* Move back-to-top up when audio player is visible */
        body.audio-playing .back-to-top {
            bottom: 90px;
        }
        @media (max-width: 640px) {
            body.audio-playing .back-to-top {
                bottom: 120px;
            }
        }

        /* Table of Contents */
        .toc {
            position: static !important;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 40px;
        }

        .toc-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .toc-list li {
            margin-bottom: 8px;
        }

        .toc-list a {
            color: var(--text-main);
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.2s;
        }

        .toc-list a:hover {
            color: var(--accent-primary);
        }

        /* Code Block Copy Button */
        pre {
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.75rem;
            color: #a0a0a0;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        pre:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .copy-btn.copied {
            background: #22c55e;
            color: #fff;
            border-color: #22c55e;
        }

        /* Link hover underlines */
        article a:not(.back-to-top):not(.author-links a):not([style]) {
            position: relative;
            text-decoration: none;
            color: var(--accent-primary);
        }

        article a:not(.back-to-top):not(.author-links a):not([style])::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--accent-primary);
            transition: width 0.3s ease;
        }

        article a:not(.back-to-top):not(.author-links a):not([style]):hover::after {
            width: 100%;
        }

        /* Bouncing scroll indicator */
        .scroll-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin: 32px 0 48px;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .scroll-indicator svg {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(8px); }
            60% { transform: translateY(4px); }
        }

        /* Collapsible code blocks */
        pre.collapsible {
            max-height: 350px;
            overflow: hidden;
        }

        pre.collapsible::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(transparent, #1e1e1e);
            z-index: 1;
            pointer-events: none;
        }

        pre.expanded {
            max-height: none;
        }

        pre.expanded::before {
            display: none;
        }

        .expand-btn {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            z-index: 2;
            transition: background 0.2s;
        }

        .expand-btn:hover {
            background: #0284c7;
        }

        /* Audio Player - Fixed at bottom */
        .audio-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .audio-player.visible {
            transform: translateY(0);
        }

        .listen-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .listen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
        }

        .listen-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .listen-btn svg {
            width: 18px;
            height: 18px;
        }

        .listen-btn.playing {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .listen-btn .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Inline listen button in header */
        .listen-btn-inline {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .listen-btn-inline:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
        }

        .listen-btn-inline svg {
            width: 18px;
            height: 18px;
        }

        /* Audio progress bar */
        .audio-progress {
            display: none;
            flex: 1;
            align-items: center;
            gap: 12px;
        }

        .audio-progress.visible {
            display: flex;
        }

        .audio-progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }

        .audio-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            width: 0%;
            transition: width 0.1s;
        }

        .audio-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: var(--font-code);
            min-width: 90px;
        }

        .audio-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .audio-close:hover {
            color: var(--text-main);
        }

        @media (max-width: 640px) {
            .audio-player {
                flex-wrap: wrap;
                gap: 12px;
                padding: 12px 16px;
            }
            .audio-progress {
                order: -1;
                width: 100%;
            }
            .listen-btn span {
                display: none;
            }
            .listen-btn {
                padding: 12px;
                border-radius: 50%;
            }
        }

        /* TTS Highlight */
        .tts-highlight {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(99, 102, 241, 0.15));
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
            transition: background 0.3s ease;
        }

        /* Before/After Demo Box */
        .demo-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin: 32px 0;
            overflow: hidden;
        }

        .demo-box-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-primary);
        }

        .demo-box-header svg {
            width: 18px;
            height: 18px;
        }

        .demo-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .demo-label.before {
            color: var(--text-muted);
        }

        .demo-label.after {
            color: #22c55e;
        }

        .demo-content {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 16px;
            font-family: var(--font-code);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        [data-theme="dark"] .demo-content {
            background: #1a1a1a;
        }

        .demo-content:last-child {
            margin-bottom: 0;
        }

        .demo-content.before-content {
            color: var(--text-muted);
            border-left: 3px solid var(--text-muted);
        }

        .demo-content.after-content {
            color: var(--text-main);
            border-left: 3px solid #22c55e;
        }

        .demo-arrow {
            display: flex;
            justify-content: center;
            margin: 16px 0;
            color: var(--accent-primary);
        }

        .demo-context {
            display: inline-block;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(192, 38, 211, 0.15));
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>
    <div class="bg-glow"></div>

    <nav>
        <a href="../../index.html"><i class="fas fa-arrow-left"></i> Back to Portfolio</a>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
            <i class="fas fa-moon"></i>
            <i class="fas fa-sun"></i>
        </button>
    </nav>

    <article class="container">
        <header class="post-header">
            <span class="post-tag"><i class="fas fa-microphone"></i> &nbsp;Voice + Privacy</span>
            <h1>Building a Voice-to-Text App That Learns Your Style (Without Storing Your Words)</h1>
            <p class="subtitle">Privacy-first style learning with TiDB vector search</p>
            <div class="post-meta">
                <time datetime="2026-01-27"><i class="far fa-calendar"></i> January 27, 2026</time>
                <span class="reading-time"><i class="far fa-clock"></i> 12 min read</span>
            </div>
            <button class="listen-btn-inline" onclick="toggleAudio()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                <span>Listen to article</span>
            </button>
        </header>

        <img src="../../imgs/speak-it-hero.jpeg" alt="Speak It - Voice-to-text with privacy-first style learning" style="width: 100%; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);" loading="lazy">

        <div class="scroll-indicator">
            <span>Scroll</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>

        <div class="toc">
            <div class="toc-title">Contents</div>
            <ul class="toc-list">
                <li><a href="#the-goal">The Goal</a></li>
                <li><a href="#the-stack">The Stack</a></li>
                <li><a href="#the-architecture">The Architecture</a></li>
                <li><a href="#the-implementation">The Implementation</a></li>
                <li><a href="#the-result">The Result</a></li>
                <li><a href="#try-it">Try It Yourself</a></li>
            </ul>
        </div>

        <h2 id="the-goal">The Goal</h2>

        <p>I talk fast. I'm also on a dozen platforms throughout the day from Gmail, Slack, Twitter, to Notion and the list keeps going. Voice-to-text tools have been around forever, but they all had the same problem: they made everything sound the same.</p>

        <p>A Slack message shouldn't read like an email. A tweet shouldn't sound like a JIRA ticket. But every transcription tool I tried would spit out the same robotic output regardless of where I was typing.</p>

        <p>So I built Speak It. Speak It is a Chrome extension that transcribes your voice anywhere on the web and formats it for the platform you're on. But here's the part I'm most proud of: it learns your writing style over time without ever storing your actual messages.</p>

        <p>Most style-learning tools keep a history of everything you've written. That's fine for personal use, but it's a non-starter for enterprise. Legal teams, compliance officers, privacy-conscious users... none of them want a third-party service storing their internal communications.</p>

        <p>The question I set out to answer: can you teach an AI how someone writes by storing statistics only? Like only focus on storing their average sentence length, formality level, and even common phrases to get a fingerprint of your style without the content itself.</p>

        <p>Turns out you can.</p>

        <div class="demo-box">
            <div class="demo-box-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
                Live Demo
            </div>
            <div class="demo-label before">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                Raw speech
            </div>
            <div class="demo-content before-content">
                hey john wanted to follow up on the proposal um let me know if you have any questions or if theres anything else you need from me thanks
            </div>
            <div class="demo-arrow">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <polyline points="19 12 12 19 5 12"/>
                </svg>
            </div>
            <div class="demo-label after">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                Formatted for email
            </div>
            <div class="demo-content after-content">
                Hey John,<br><br>Wanted to follow up on the proposal. Let me know if you have any questions or if there's anything else you need from me.<br><br>Thanks
            </div>
        </div>

        <h2 id="the-stack">The Stack</h2>

        <p>Here's what I used and why:</p>

        <p><strong>Chrome Extension</strong> - The app needs to work on any website, not just one platform. A browser extension was the only way to inject a mic button into Gmail, Slack, Notion, Twitter, and everywhere else.</p>

        <p><strong>Web Speech API + Deepgram</strong> - Chrome and Edge support the Web Speech API for free. For browsers that don't (Arc, Safari, Firefox), I fall back to Deepgram's streaming API. This keeps costs low for most users while maintaining broad compatibility.</p>

        <p><strong>TiDB Cloud Starter</strong> - I didn't want to run two databases (one for normal data and one for vectors). TiDB can handle both vectors and business data all in one database. It's also MySQL-compatible, which means I could stick to what I already know. And it scales to zero when idle so I'm not paying for unused capacity.</p>

        <p><strong>Claude Sonnet 4</strong> - I use Claude Sonnet 4 as the formatting engine. It takes raw transcripts and reformats them based on context and style instructions. Sonnet follows constraints well without over-editing (which is extremely important in this context).</p>

        <p><strong>OpenAI Embeddings</strong> - For embeddings, I use text-embedding-3-small with OpenAI. It generates vector representations of writing style samples. These power the similarity matching for style clustering.</p>

        <h2 id="the-architecture">The Architecture</h2>

        <p>Here's how data flows through the system:</p>

        <div class="architecture-diagram">[User speaks]
      ↓
[Deepgram / Web Speech API]
      ↓
[Raw transcript]
      ↓
[Context detection: Gmail? Slack? Twitter?]
      ↓
[Fetch style profile from TiDB]
      ↓
[Claude formats transcript using style + context]
      ↓
[User accepts or rejects suggestion]
      ↓
[Extract stats from accepted text]
      ↓
[Update style profile in TiDB]
      ↓
[Generate embedding for similarity matching]</div>

        <p>The key architectural decision was storing stats, not content. Here's what goes into a style profile:</p>

        <table>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Example</th>
            </tr>
            <tr>
                <td>avg_sentence_length</td>
                <td>float</td>
                <td>14.2</td>
            </tr>
            <tr>
                <td>formality_score</td>
                <td>float (0-1)</td>
                <td>0.35</td>
            </tr>
            <tr>
                <td>uses_contractions</td>
                <td>boolean</td>
                <td>true</td>
            </tr>
            <tr>
                <td>greetings</td>
                <td>JSON array</td>
                <td>["Hey", "Hi there"]</td>
            </tr>
            <tr>
                <td>signoffs</td>
                <td>JSON array</td>
                <td>["Thanks", "Cheers"]</td>
            </tr>
            <tr>
                <td>top_phrases</td>
                <td>JSON array</td>
                <td>["sounds good", "let me know"]</td>
            </tr>
        </table>

        <p>None of this is the actual message. It's a fingerprint of how you write, not what you write.</p>

        <div class="callout">
            <p>Enterprise customers won't touch a tool that stores their internal communications. This constraint shaped every design decision.</p>
        </div>

        <h2 id="the-implementation">The Implementation</h2>

        <h3>Context Detection</h3>

        <p>Different platforms have different norms. LinkedIn tends to be much more formal compared to X. A Slack message shouldn't read like an email. So the first thing I did was figure out where the user would be typing.</p>

        <p>The extension matches the current URL against known patterns, then looks for platform-specific DOM selectors to find the active text field:</p>

        <pre class="language-javascript"><code class="language-javascript">const CONTEXT_PATTERNS = {
  email: {
    urls: [/mail\.google\.com/, /outlook\.live\.com/, /outlook\.office\.com/],
    selectors: [
      '[aria-label="Message Body"]',
      '[role="textbox"][aria-multiline="true"]',
      'div[contenteditable="true"][g_editable="true"]',
    ],
  },
  slack: {
    urls: [/\.slack\.com/],
    selectors: [
      '[data-qa="message_input"]',
      '.ql-editor',
      '[contenteditable="true"][data-message-input]',
    ],
  },
  twitter: {
    urls: [/twitter\.com/, /x\.com/],
    selectors: [
      '[data-testid="tweetTextarea_0"]',
      '[role="textbox"][data-testid]',
    ],
  },
  // ... 20+ contexts total
};</code></pre>

        <p>This detection runs before any formatting happens. The detected context determines both how Claude formats the text and what platform-specific instructions it receives.</p>

        <p>X (formerly Twitter) formatting keeps things brief and removes formal greetings. Email formatting preserves sign-offs and adds paragraph breaks. Slack sits somewhere in between.</p>

        <div class="demo-box">
            <div class="demo-box-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
                Same input, different platforms
            </div>
            <div class="demo-label before">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                Raw speech
            </div>
            <div class="demo-content before-content">
                just finished the new feature its ready for review whenever you get a chance
            </div>
            <div class="demo-arrow">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <polyline points="19 12 12 19 5 12"/>
                </svg>
            </div>
            <span class="demo-context">Gmail</span>
            <div class="demo-content after-content">
                Hey,<br><br>Just finished the new feature. It's ready for review whenever you get a chance.<br><br>Thanks
            </div>
            <span class="demo-context">Slack</span>
            <div class="demo-content after-content">
                Just finished the new feature. Ready for review whenever you get a chance
            </div>
            <span class="demo-context">X / Twitter</span>
            <div class="demo-content after-content">
                Just finished the new feature. Ready for review whenever you get a chance.
            </div>
        </div>

        <h3>Style Profile Schema</h3>

        <p>The style profile lives in TiDB. Here's the table structure:</p>

        <pre class="language-sql"><code class="language-sql">CREATE TABLE user_style_profiles (
  user_id VARCHAR(255) PRIMARY KEY,
  avg_sentence_length FLOAT DEFAULT 12,
  formality_score FLOAT DEFAULT 0.5,
  uses_contractions BOOLEAN DEFAULT TRUE,
  top_phrases JSON,
  greetings JSON,
  signoffs JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);</code></pre>

        <p>Notice there's no message_content column. We're storing how you write, not what you write.</p>

        <p>The formality_score ranges from 0 (very casual) to 1 (very formal). This gets calculated from signals like sentence length, punctuation patterns, and word choice. Someone who writes "Hey! Quick question, can u send that over?" scores lower than someone who writes "Good afternoon. I wanted to follow up regarding the materials."</p>

        <p>Fetching a profile is a simple query:</p>

        <pre class="language-typescript"><code class="language-typescript">async function getUserStyleProfile(userId: string): Promise<StyleProfile | null> {
  const [rows] = await connection.execute<RowDataPacket[]>(
    `SELECT avg_sentence_length, formality_score, uses_contractions,
            top_phrases, greetings, signoffs
     FROM user_style_profiles WHERE user_id = ?`,
    [userId]
  );

  if (rows.length === 0) return null;

  const row = rows[0];
  return {
    avg_sentence_length: row.avg_sentence_length || 12,
    formality_score: row.formality_score || 0.5,
    uses_contractions: row.uses_contractions !== false,
    top_phrases: row.top_phrases ? JSON.parse(row.top_phrases) : [],
    greetings: row.greetings ? JSON.parse(row.greetings) : ["Hey"],
    signoffs: row.signoffs ? JSON.parse(row.signoffs) : ["Thanks"],
  };
}</code></pre>

        <p>New users get sensible defaults. The profile evolves as they accept or reject formatting suggestions.</p>

        <h3>The Formatting Prompt</h3>

        <p>The style profile turns into prompt instructions. Claude doesn't see historical messages, it sees constraints.</p>

        <pre class="language-typescript"><code class="language-typescript">function buildStylePrompt(profile: StyleProfile | null, context: string): string {
  if (!profile) {
    return `Format this transcript for ${context}. Keep it natural and conversational.`;
  }

  const formality = profile.formality_score > 0.7 ? "formal" :
                    profile.formality_score < 0.3 ? "casual" : "balanced";

  const contractionNote = profile.uses_contractions
    ? "Use contractions naturally (don't, won't, can't)."
    : "Minimize contractions for a more formal tone.";

  const greetingNote = profile.greetings.length > 0
    ? `Preferred greetings: ${profile.greetings.slice(0, 3).join(", ")}`
    : "";

  const signoffNote = profile.signoffs.length > 0
    ? `Preferred sign-offs: ${profile.signoffs.slice(0, 3).join(", ")}`
    : "";

  return `Format this transcript for ${context}.

User's writing style:
- Tone: ${formality}
- Average sentence length: ~${Math.round(profile.avg_sentence_length)} words
- ${contractionNote}
${greetingNote ? `- ${greetingNote}` : ""}
${signoffNote ? `- ${signoffNote}` : ""}

Rules:
1. ONLY add punctuation and paragraph breaks
2. Remove filler words: um, uh, like, basically, you know
3. Keep EVERY other word exactly as they said it
4. Do NOT rewrite, rephrase, or "clean up" their language`;
}</code></pre>

        <p>The rules at the bottom are critical. Without them, Claude will "improve" the user's words. But people don't want their voice replaced, they just want it cleaned up. There's a difference.</p>

        <div class="demo-box">
            <div class="demo-box-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Style-matched output
            </div>
            <div class="demo-label before">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                Same raw speech
            </div>
            <div class="demo-content before-content">
                can we push the meeting to tomorrow something came up
            </div>
            <div class="demo-arrow">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <polyline points="19 12 12 19 5 12"/>
                </svg>
            </div>
            <span class="demo-context">Casual user (formality: 0.2)</span>
            <div class="demo-content after-content">
                Hey! Can we push the meeting to tomorrow? Something came up
            </div>
            <span class="demo-context">Formal user (formality: 0.8)</span>
            <div class="demo-content after-content">
                Hello,<br><br>Would it be possible to reschedule our meeting to tomorrow? Something has come up.<br><br>Thank you
            </div>
        </div>

        <p>Each context also gets platform-specific instructions:</p>

        <pre class="language-typescript"><code class="language-typescript">function getContextInstructions(context: string): string {
  switch (context) {
    case "email":
      return `Email format:
- Add punctuation and paragraph breaks
- Keep their exact words
- Add sign-off if missing`;

    case "slack":
      return `Slack format:
- Keep it brief and casual
- No formal greetings needed
- Okay to use shorter sentences`;

    case "twitter":
      return `Twitter/X format:
- Add punctuation only
- Keep their exact words
- If over 280 characters, don't trim`;

    // ... more contexts
  }
}</code></pre>

        <p>The combination of style profile and context instructions gives Claude enough guidance to format appropriately without overstepping.</p>

        <h3>The Learning Loop</h3>

        <p>Here's the part I'm still iterating on.</p>

        <p>When a user accepts or rejects a format suggestion, I want to update their profile. The naive approach was to just overwrite the stats with the new sample.</p>

        <p>But that was wrong.</p>

        <p>If someone has been using the app for months and their profile reflects hundreds of accepted formats, a single new sample shouldn't dramatically shift their stats. New samples need to have less influence as the profile matures.</p>

        <p>The solution is weighted averaging. Each new sample contributes a fraction to the running average, with that fraction decreasing over time:</p>

        <pre class="language-typescript"><code class="language-typescript">function updateStyleProfile(
  existingProfile: StyleProfile,
  newStats: TextStats,
  sampleCount: number
): StyleProfile {
  // Weight decreases as sample count increases
  // First sample: 100% weight. 100th sample: ~1% weight.
  const weight = 1 / (sampleCount + 1);

  return {
    avg_sentence_length:
      existingProfile.avg_sentence_length * (1 - weight) +
      newStats.avg_sentence_length * weight,
    formality_score:
      existingProfile.formality_score * (1 - weight) +
      calculateFormality(newStats) * weight,
    // ... other fields
  };
}</code></pre>

        <p>For phrases, greetings, and signoffs, I track frequency counts rather than just presence. A greeting you use once shouldn't rank the same as one you use constantly.</p>

        <p>I'm also generating embeddings for each accepted format:</p>

        <pre class="language-typescript"><code class="language-typescript">const embeddingResponse = await openai.embeddings.create({
  model: "text-embedding-3-small",
  input: `Sentence length: ${stats.avg_sentence_length}. ` +
         `Formality: ${stats.formality_score}. ` +
         `Context: ${context}. ` +
         `Contractions: ${stats.uses_contractions}`,
});
const styleEmbedding = embeddingResponse.data[0].embedding;</code></pre>

        <p>The idea here is to cluster similar writing styles together. Users who write like you might have formatting preferences you'd also like. But I'll be honest: this piece isn't fully wired up yet. I'm generating the embeddings but not querying them for recommendations.</p>

        <p>That's the next iteration.</p>

        <h2 id="the-result">The Result</h2>

        <p>What works today:</p>

        <ul>
            <li>Voice-to-text on 20+ platforms (Gmail, Slack, Notion, Twitter, LinkedIn, GitHub, and more)</li>
            <li>Automatic context detection: no manual switching</li>
            <li>Style profiles that influence formatting output</li>
            <li>Privacy-first design: statistics only, no content stored</li>
        </ul>

        <p>What's next:</p>

        <ul>
            <li>Vector similarity for style clustering ("users who write like you prefer...")</li>
            <li>Refined feedback loop for profile updates</li>
            <li>Multi-language support beyond English</li>
            <li>Browser support expansion (Firefox add-on)</li>
        </ul>

        <h2 id="try-it">Try It Yourself</h2>

        <p>If you want to build something similar, TiDB Cloud's Starter gives you enough runway to experiment. The combination of relational tables (for user profiles) and vector search (for style similarity) in one database simplified my architecture significantly.</p>

        <p>The main insight from building this: personalization doesn't require surveillance. You can learn patterns without learning secrets. Statistical fingerprints give you enough signal to customize behavior while keeping actual content out of your database entirely.</p>

        <p>For enterprise use cases where privacy is non-negotiable, this approach opens doors that content-based learning keeps closed.</p>

        <p style="margin-top: 32px;">
            <a href="https://github.com/RealChrisSean/Speak-It" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 12px 24px; background: var(--accent-primary); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1rem; transition: all 0.3s; margin-right: 12px;">
                GitHub <i class="fab fa-github" style="font-size: 0.85rem;"></i>
            </a>
            <a href="https://app.parallellives.ai/speak-it" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 12px 24px; background: transparent; border: 2px solid var(--accent-primary); color: var(--accent-primary); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1rem; transition: all 0.3s;">
                Get Speak It <i class="fas fa-external-link-alt" style="font-size: 0.85rem;"></i>
            </a>
        </p>

        <hr>

        <div class="author-section">
            <img src="../../imgs/chrisdabatos.webp" alt="Chris Dabatos - Developer Advocate and Engineer" class="author-avatar" loading="lazy">
            <div class="author-info">
                <p class="author-name">Chris Dabatos</p>
                <p class="author-title">Developer Advocate, Engineer, Speaker</p>
                <div class="author-links">
                    <a href="https://www.linkedin.com/in/realchrissean/" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                    <a href="https://x.com/RealChrisSean" target="_blank" aria-label="Twitter"><i class="fab fa-x-twitter"></i></a>
                    <a href="https://github.com/realchrissean" target="_blank" aria-label="GitHub"><i class="fab fa-github"></i></a>
                    <a href="https://www.youtube.com/@RealChrisSean/videos" target="_blank" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-social">
                <a href="https://x.com/RealChrisSean" target="_blank" aria-label="Follow on X (Twitter)"><i class="fab fa-x-twitter"></i></a>
                <a href="https://github.com/realchrissean" target="_blank" aria-label="View GitHub profile"><i class="fab fa-github"></i></a>
                <a href="https://www.linkedin.com/in/realchrissean/" target="_blank" aria-label="Connect on LinkedIn"><i class="fab fa-linkedin"></i></a>
                <a href="https://www.youtube.com/@RealChrisSean/videos" target="_blank" aria-label="Subscribe on YouTube"><i class="fab fa-youtube"></i></a>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-muted);">&copy; 2026 Chris Dabatos. Made with code & caffeine in Las Vegas.</p>
        </div>
    </article>

    <button class="back-to-top" id="backToTop" aria-label="Back to top">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>

    <!-- Fixed Audio Player -->
    <div class="audio-player" id="audioPlayer">
        <button class="listen-btn" id="listenBtn" onclick="toggleAudio()">
            <svg id="playIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </svg>
            <svg id="loadingIcon" class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"/>
            </svg>
            <span id="listenText">Play</span>
        </button>
        <div class="audio-progress visible" id="audioProgress">
            <div class="audio-progress-bar" onclick="seekAudio(event)">
                <div class="audio-progress-fill" id="audioProgressFill"></div>
            </div>
            <span class="audio-time" id="audioTime">0:00 / 0:00</span>
        </div>
        <button class="audio-close" onclick="closeAudioPlayer()" aria-label="Close player">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    <!-- Custom Analytics -->
    <script src="/analytics.js"></script>

    <!-- TTS Audio Player -->
    <script>
        let audioPlayer = null;
        let isPlaying = false;
        let isLoading = false;
        let paragraphs = [];
        let paragraphTimings = [];

        // Pre-cached files for this blog
        const PRECACHED_AUDIO = '/audio/speak-it.mp3';
        const PRECACHED_TIMESTAMPS = '/audio/speak-it-timestamps.json';
        let wordTimings = [];

        function getReadableParagraphs() {
            const article = document.querySelector('article.container');
            const elements = article.querySelectorAll('h2, h3, p, li');
            const readable = [];

            elements.forEach(el => {
                // Skip elements inside excluded sections
                if (el.closest('.post-header, .toc, .author-section, .footer, .demo-box, .architecture-diagram, pre, code, table, nav, .scroll-indicator, .audio-progress')) {
                    return;
                }
                const text = el.textContent.trim();
                if (text.length > 10) {
                    readable.push({ element: el, text });
                }
            });

            return readable;
        }

        function getArticleText() {
            paragraphs = getReadableParagraphs();
            return paragraphs.map(p => p.text).join(' ');
        }

        function calculateParagraphTimings(duration) {
            const totalChars = paragraphs.reduce((sum, p) => sum + p.text.length, 0);
            let currentTime = 0;

            paragraphTimings = paragraphs.map(p => {
                const start = currentTime;
                const paragraphDuration = (p.text.length / totalChars) * duration;
                currentTime += paragraphDuration;
                return { start, end: currentTime, element: p.element };
            });
        }

        function highlightCurrentParagraph(currentTime) {
            // Remove previous highlights
            document.querySelectorAll('.tts-highlight').forEach(el => {
                el.classList.remove('tts-highlight');
            });

            // Use word-level timestamps if available
            if (wordTimings.length > 0) {
                // Find current word
                let currentWordIndex = -1;
                for (let i = 0; i < wordTimings.length; i++) {
                    if (currentTime >= wordTimings[i].start && currentTime < wordTimings[i].end) {
                        currentWordIndex = i;
                        break;
                    }
                    if (currentTime < wordTimings[i].start) {
                        currentWordIndex = Math.max(0, i - 1);
                        break;
                    }
                }

                if (currentWordIndex >= 0) {
                    // Get a phrase of ~5 words around current word for matching
                    const startIdx = Math.max(0, currentWordIndex - 2);
                    const endIdx = Math.min(wordTimings.length, currentWordIndex + 3);
                    const phrase = wordTimings.slice(startIdx, endIdx).map(w => w.word).join(' ').toLowerCase();

                    // Find paragraph containing this phrase
                    for (const p of paragraphs) {
                        if (p.text.toLowerCase().includes(phrase) ||
                            phrase.includes(p.text.toLowerCase().substring(0, 30))) {
                            p.element.classList.add('tts-highlight');
                            return;
                        }
                    }

                    // Fallback: match single word
                    const currentWord = wordTimings[currentWordIndex].word.toLowerCase();
                    for (const p of paragraphs) {
                        if (p.text.toLowerCase().includes(currentWord)) {
                            p.element.classList.add('tts-highlight');
                            return;
                        }
                    }
                }
            } else {
                // Fallback to estimated timing
                for (let i = 0; i < paragraphTimings.length; i++) {
                    const timing = paragraphTimings[i];
                    if (currentTime >= timing.start && currentTime < timing.end) {
                        timing.element.classList.add('tts-highlight');
                        break;
                    }
                }
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateUI(state) {
            const player = document.getElementById('audioPlayer');
            const btn = document.getElementById('listenBtn');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            const loadingIcon = document.getElementById('loadingIcon');
            const listenText = document.getElementById('listenText');

            playIcon.style.display = 'none';
            pauseIcon.style.display = 'none';
            loadingIcon.style.display = 'none';

            switch (state) {
                case 'loading':
                    player.classList.add('visible');
                    document.body.classList.add('audio-playing');
                    loadingIcon.style.display = 'block';
                    listenText.textContent = 'Loading...';
                    btn.disabled = true;
                    break;
                case 'playing':
                    player.classList.add('visible');
                    document.body.classList.add('audio-playing');
                    pauseIcon.style.display = 'block';
                    listenText.textContent = 'Pause';
                    btn.classList.add('playing');
                    btn.disabled = false;
                    break;
                case 'paused':
                    player.classList.add('visible');
                    document.body.classList.add('audio-playing');
                    playIcon.style.display = 'block';
                    listenText.textContent = 'Play';
                    btn.classList.remove('playing');
                    btn.disabled = false;
                    break;
                default:
                    player.classList.remove('visible');
                    document.body.classList.remove('audio-playing');
                    playIcon.style.display = 'block';
                    listenText.textContent = 'Play';
                    btn.classList.remove('playing');
                    btn.disabled = false;
                    document.querySelectorAll('.tts-highlight').forEach(el => {
                        el.classList.remove('tts-highlight');
                    });
            }
        }

        function seekAudio(event) {
            if (!audioPlayer) return;
            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }

        function closeAudioPlayer() {
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer = null;
            }
            isPlaying = false;
            updateUI('idle');
        }

        async function toggleAudio() {
            if (isLoading) return;

            if (audioPlayer && isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
                updateUI('paused');
                return;
            }

            if (audioPlayer && !isPlaying) {
                audioPlayer.play();
                isPlaying = true;
                updateUI('playing');
                return;
            }

            // First time - try pre-cached audio first, fall back to API
            isLoading = true;
            updateUI('loading');

            try {
                // Get paragraphs for highlighting
                getArticleText();

                // Try pre-cached audio and timestamps first
                let audioUrl = PRECACHED_AUDIO;
                let usedCache = false;

                try {
                    const [audioCheck, timestampsResponse] = await Promise.all([
                        fetch(PRECACHED_AUDIO, { method: 'HEAD' }),
                        fetch(PRECACHED_TIMESTAMPS)
                    ]);

                    if (audioCheck.ok && timestampsResponse.ok) {
                        usedCache = true;
                        const timestampData = await timestampsResponse.json();
                        wordTimings = timestampData.words || [];
                        console.log('Using pre-cached audio with', wordTimings.length, 'word timings');
                    }
                } catch (e) {
                    console.log('Pre-cached files not available, falling back to API');
                }

                if (!usedCache) {
                    // Fall back to API
                    const text = paragraphs.map(p => p.text).join(' ');
                    const response = await fetch('/api/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text,
                            voice: 'kdvGwzzf2ihYtjbv5OWc',
                            stability: 0.5,
                            similarity: 0.75
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'TTS request failed');
                    }

                    const blob = await response.blob();
                    audioUrl = URL.createObjectURL(blob);
                }

                audioPlayer = new Audio(audioUrl);

                audioPlayer.addEventListener('loadedmetadata', () => {
                    calculateParagraphTimings(audioPlayer.duration);
                });

                audioPlayer.addEventListener('timeupdate', () => {
                    const progressFill = document.getElementById('audioProgressFill');
                    const timeDisplay = document.getElementById('audioTime');
                    const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressFill.style.width = percent + '%';
                    timeDisplay.textContent = `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;

                    // Highlight current paragraph
                    highlightCurrentParagraph(audioPlayer.currentTime);
                });

                audioPlayer.addEventListener('ended', () => {
                    isPlaying = false;
                    audioPlayer = null;
                    updateUI('idle');
                });

                audioPlayer.play();
                isPlaying = true;
                isLoading = false;
                updateUI('playing');

            } catch (error) {
                console.error('TTS error:', error);
                isLoading = false;
                updateUI('idle');
                alert('Failed to load audio. Please try again.');
            }
        }
    </script>

    <!-- Progress Bar & Scroll Animations -->
    <script>
        // Reading Progress Bar
        const progressBar = document.getElementById('progressBar');

        function updateProgressBar() {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = (scrollTop / docHeight) * 100;
            progressBar.style.width = progress + '%';
        }

        window.addEventListener('scroll', updateProgressBar);
        updateProgressBar();

        // Scroll Animations
        function initScrollAnimations() {
            // Add fade-up class to sections
            const sections = document.querySelectorAll('h2, .highlight-box, pre, .cta-section, .author-section, p, ul, ol');
            sections.forEach(el => {
                if (!el.closest('nav') && !el.closest('.hero')) {
                    el.classList.add('fade-up');
                }
            });

            // Intersection Observer for animations
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            document.querySelectorAll('.fade-up').forEach(el => observer.observe(el));
        }

        // Run after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initScrollAnimations);
        } else {
            initScrollAnimations();
        }

        // Back to Top Button
        const backToTop = document.getElementById('backToTop');

        window.addEventListener('scroll', () => {
            if (window.scrollY > 500) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        });

        backToTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Copy Code Button & Collapsible Code
        document.querySelectorAll('pre[class*="language-"]').forEach(pre => {
            // Copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', async () => {
                const code = pre.querySelector('code')?.textContent || pre.textContent;
                await navigator.clipboard.writeText(code);
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
            pre.appendChild(copyBtn);

            // Collapsible for tall code blocks
            const codeEl = pre.querySelector('code');
            if (codeEl) {
                const lineCount = (codeEl.textContent.match(/\n/g) || []).length + 1;
                if (lineCount > 15) {
                    pre.classList.add('collapsible');
                    const expandBtn = document.createElement('button');
                    expandBtn.className = 'expand-btn';
                    expandBtn.textContent = 'Show more';
                    expandBtn.addEventListener('click', () => {
                        if (pre.classList.contains('expanded')) {
                            pre.classList.remove('expanded');
                            expandBtn.textContent = 'Show more';
                        } else {
                            pre.classList.add('expanded');
                            expandBtn.textContent = 'Show less';
                        }
                    });
                    pre.appendChild(expandBtn);
                }
            }
        });
    </script>
</body>
</html>
